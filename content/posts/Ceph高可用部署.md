---
title: "Cephé«˜å¯ç”¨éƒ¨ç½²"
date: 2022-09-15T11:30:03+00:00
# weight: 1
# aliases: ["/first"]
tags: ["è¿ç»´","å­˜å‚¨","äº‘åŸç”Ÿ"]
author: "Esqer"
showToc: true
TocOpen: true
draft: false
hidemeta: false
comments: true
description: "æœ¬æ–‡ä»‹ç»å¦‚ä½•é«˜å¯ç”¨éƒ¨ç½²Cephé›†ç¾¤ï¼ŒCephçš„ä¸»è¦ç»„ä»¶"
disableHLJS: true # to disable highlightjs
disableShare: false
disableHLJS: false
hideSummary: false
searchHidden: true
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowWordCount: true
ShowRssButtonInSectionTermList: true
UseHugoToc: true
editPost:
    URL: "https://github.com/EsqerYasen/EsqerYasen.github.io/content"
    Text: "Edit This Page" # edit text
    appendFilePath: true # to append file path to Edit link
---

# Ceph å­¦ä¹ æ–‡æ¡£

æœ¬æ•™ç¨‹ç”¨å®˜ç½‘æœ€è¿‘çš„cephadmæ¥æ­å»ºcephé›†ç¾¤ã€‚

> æ¦‚è§ˆ
> 1.cephçš„ç»„ä»¶å’ŒåŠŸèƒ½
> 2.cephçš„æ•°æ®è¯»å†™æµç¨‹
> 3.ä½¿ç”¨ceph-deployå®‰è£…ä¸€ä¸ªæœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹çš„cephé›†ç¾¤
>  æ¨è3ä¸ªæˆ–ä»¥ä¸Šçš„ç£ç›˜ä½œä¸ºä¸“ç”¨osd 
> 4.æµ‹è¯•cephçš„rbdä½¿ç”¨

## 1Â·Cephç»„ä»¶å’ŒåŠŸèƒ½

### ç»„ä»¶

- **Ceph OSDs**: ( Ceph OSD ï¼‰object storage daemonçš„åŠŸèƒ½æ˜¯å­˜å‚¨æ•°æ®ï¼Œå¤„ç†æ•°æ®çš„å¤åˆ¶ã€æ¢å¤ã€å›å¡«ã€å†å‡è¡¡ï¼Œå¹¶é€šè¿‡æ£€æŸ¥å…¶ä»–OSD å®ˆæŠ¤è¿›ç¨‹çš„å¿ƒè·³æ¥å‘ Ceph Monitors æä¾›ä¸€äº›ç›‘æ§ä¿¡æ¯ã€‚å½“ Ceph å­˜å‚¨é›†ç¾¤è®¾å®šä¸ºæœ‰2ä¸ªå‰¯æœ¬æ—¶ï¼Œè‡³å°‘éœ€è¦2ä¸ª OSD å®ˆæŠ¤è¿›ç¨‹ï¼Œé›†ç¾¤æ‰èƒ½è¾¾åˆ° `active+clean` çŠ¶æ€ï¼ˆ Ceph é»˜è®¤æœ‰3ä¸ªå‰¯æœ¬ï¼Œä½†ä½ å¯ä»¥è°ƒæ•´å‰¯æœ¬æ•°ï¼‰ã€‚
- **Monitors**: ç»´æŠ¤ç€å±•ç¤ºé›†ç¾¤çŠ¶æ€çš„å„ç§å›¾è¡¨ï¼ŒåŒ…æ‹¬ç›‘è§†å™¨å›¾ã€ OSD å›¾ã€å½’ç½®ç»„ï¼ˆ PG ï¼‰å›¾ã€å’Œ CRUSH å›¾ã€‚ Ceph ä¿å­˜ç€å‘ç”Ÿåœ¨Monitors ã€ OSD å’Œ PGä¸Šçš„æ¯ä¸€æ¬¡çŠ¶æ€å˜æ›´çš„å†å²ä¿¡æ¯ï¼ˆç§°ä¸º epoch ï¼‰ã€‚

- **MDSs**: Ceph å…ƒæ•°æ®æœåŠ¡å™¨ä¸º Ceph æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨å…ƒæ•°æ®ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼ŒCeph å—è®¾å¤‡å’Œ Ceph å¯¹è±¡å­˜å‚¨ä¸ä½¿ç”¨MDS ï¼‰ã€‚å…ƒæ•°æ®æœåŠ¡å™¨ä½¿å¾— POSIX æ–‡ä»¶ç³»ç»Ÿçš„ç”¨æˆ·ä»¬ï¼Œå¯ä»¥åœ¨ä¸å¯¹ Ceph å­˜å‚¨é›†ç¾¤é€ æˆè´Ÿæ‹…çš„å‰æä¸‹ï¼Œæ‰§è¡Œè¯¸å¦‚ `ls`ã€`find` ç­‰åŸºæœ¬å‘½ä»¤ã€‚
- **CephMgr**ï¼šåœ¨ä¸€ä¸ªä¸»æœºä¸Šçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£è¿è¡ŒæŒ‡æ ‡ï¼Œè¿è¡ŒçŠ¶æ€ï¼Œæ€§èƒ½è´Ÿè½½ï¼Œ

### å…¶ä»–æœ¯è¯­ï¼š

RADOSï¼šå¤šä¸ªä¸»æœºç»„æˆçš„å­˜å‚¨é›†ç¾¤ï¼Œå³å¯é ï¼Œè‡ªåŠ¨åŒ–ï¼Œåˆ†å¸ƒå¼çš„å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚

File:  å°±æ˜¯æ™®é€šæ–‡ä»¶ï¼ŒObjectRADOSçœ‹åˆ°çš„å¯¹è±¡ï¼ŒObjectä¸Fileçš„åŒºåˆ«æ˜¯ï¼Œ Objectçš„æœ€å¤§å°ºå¯¸ç”±RADOSé™å®š(é€šå¸¸ä¸º2MBæˆ–4MB) ï¼Œä»¥ä¾¿å®ç°åº•å±‚å­˜å‚¨çš„ç»„ç»‡ç®¡ç†ã€‚å› æ­¤ï¼Œå½“ä¸Šå±‚åº”ç”¨å‘RADOSå­˜å…¥å°ºå¯¸å¾ˆå¤§çš„Fileæ—¶ï¼Œéœ€è¦å°†Fileåˆ‡åˆ†æˆç»Ÿä¸€å¤§å°çš„ä¸€ç³»åˆ—Objet (æœ€åä¸€ä¸ªçš„å¤§å°å¯ä»¥ä¸åŒ)è¿›è¡Œå­˜å‚¨ã€‚

libradosï¼šRADOSé›†ç¾¤çš„APIï¼Œæ”¯æŒå¤§éƒ¨åˆ†ä¸»æµè¯­è¨€ã€‚

Poolï¼šå­˜å‚¨æ± ï¼Œå¤§å°å–å†³äºåº•å±‚çš„å­˜å‚¨ç©ºé—´ã€‚

PGï¼šplaceholder groupï¼Œä¸€ä¸ªpoolï¼ˆå­˜å‚¨æ± ï¼‰å†…å¯ä»¥æœ‰å¤šä¸ªPGï¼Œpoolä¸ªpgéƒ½æ˜¯æŠ½è±¡çš„é€»è¾‘æ¦‚å¿µï¼Œå¯ä»¥é€šè¿‡å…¬ç¤ºè®¡ç®—ã€‚PGçš„ç”¨é€”æ˜¯å¯¹Objectçš„å­˜å‚¨è¿›è¡Œç»„ç»‡å’Œä½ç½®æ˜ å°„çš„ã€‚å…·ä½“è€Œè¨€ï¼Œä¸€ä¸ªPGè´Ÿè´£ç»„ç»‡è‹¥å¹²ä¸ªObjectï¼Œä½†ä¸€ä¸ªObiectåªèƒ½è¢«æ˜ å°„åˆ°ä¸€ä¸ªPGä¸­ï¼Œå³PGå’ŒObjectä¹‹é—´æ˜¯â€œä¸€å¯¹å¤šâ€çš„æ˜ å°„å…³ç³»ã€‚åŒæ—¶ï¼Œä¸€ä¸ªPGä¼šè¢«æ˜ å°„åˆ°nä¸ªOSDä¸Šï¼Œè€Œæ¯ä¸ªOSDä¸Šéƒ½ä¼šæ‰¿è½½å¤§é‡çš„PGï¼Œå³PGå’ŒOSDä¹‹é—´æ˜¯â€œå¤šå¯¹å¤šâ€çš„æ˜ å°„å…³ç³»ã€‚åœ¨å®è·µå½“ä¸­ï¼Œnè‡³å°‘ä¸º2ï¼Œå¦‚æœç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œåˆ™è‡³å°‘ä¸º3ã€‚ä¸€ä¸ªOSDä¸Šçš„PGå¯è¾¾åˆ°æ•°ç™¾ä¸ªã€‚äº‹å®ä¸Šï¼Œ PGæ•°é‡çš„è®¾ç½®å…³ç³»åˆ°æ•°æ®åˆ†å¸ƒçš„å‡åŒ€æ€§é—®é¢˜ã€‚

OSD daemonï¼šé»˜è®¤æ¯2ç§’å‘é€çŠ¶æ€æ•°æ®ç»™monitorï¼Œï¼ˆåŒæ—¶ç›‘æ§ç»„å†…å…¶ä»–OSDçš„çŠ¶æ€ï¼‰ï¼ˆup å¯ä»¥æä¾›IOï¼Œdownä¸èƒ½æä¾›ï¼Œinæœ‰æ•°æ®ï¼Œoutæ²¡æœ‰æ•°æ®ï¼‰

PGå’ŒOSDä¹‹é—´çš„å…³ç³»é€šè¿‡CRUSHç®—æ³•å¾—å‡ºçš„ã€‚å¸¸è§„è¿™ä¸‰ä¸ª OSD daemon å¯ä»¥åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒæœºå™¨ä¸Šï¼›é‚£ä¹ˆæ ¹æ® CRUSH ç®—æ³•ä¼šå°½å¯èƒ½çš„ä¿è¯ä¸€ä¸ªå¹³è¡¡ï¼Œå°±æ˜¯ä¸åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šï¼›æ¯•ç«ŸCephä¸­çš„æ•°æ®æ˜¯ä¸€ä¸ªä¸ºå¹³è¡¡çš„çŠ¶æ€ï¼Œä¸€åˆ‡éƒ½æ˜¯é€šè¿‡CRUSH ç®—æ³•æ¥å®ç°çš„æ•°æ®å¹³è¡¡ï¼Œè€Œ PG æœ¬èº«æ˜¯ä¸ªæœ‰åºåˆ—è¡¨ï¼Œä½äºç¬¬ä¸€çš„ä½ç½®æ˜¯ masterï¼›è¿™ä¸ªåˆ—è¡¨çš„äº§ç”Ÿæ˜¯ç”± monitor æ¥äº§ç”Ÿçš„ï¼›

### å¯»å€æµç¨‹

**File->Objectæ˜ å°„**
è¿™æ¬¡æ˜ å°„çš„ç›®çš„æ˜¯ï¼Œå°†ç”¨æˆ·è¦æ“ä½œçš„Fileæ˜ å°„ä¸ºRADOSèƒ½å¤Ÿå¤„ç†çš„Objectï¼Œå…¶ååˆ†ç®€å•ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æŒ‰ç…§Objectçš„æœ€å¤§å°ºå¯¸ï¼ˆé»˜è®¤4Mï¼‰å¯¹Fileè¿›è¡Œåˆ‡åˆ†ï¼Œç›¸å½“äºç£ç›˜é˜µåˆ—ä¸­çš„æ¡å¸¦åŒ–è¿‡ç¨‹ã€‚è¿™ç§åˆ‡åˆ†çš„å¥½å¤„æœ‰ä¸¤ä¸ª:ä¸€æ˜¯è®©å¤§å°ä¸é™çš„Fileå˜æˆå…·æœ‰ä¸€è‡´çš„æœ€å¤§å°ºå¯¸ã€å¯ä»¥è¢«RADOSé«˜æ•ˆç®¡ç†çš„Object;äºŒæ˜¯è®©å¯¹å•ä¸€Fileå®æ–½çš„ä¸²è¡Œå¤„ç†å˜ä¸ºå¯¹å¤šä¸ªObjectå®æ–½çš„å¹¶è¡ŒåŒ–å¤„ç†ã€‚
æ¯ä¸€ä¸ªåˆ‡åˆ†åäº§ç”Ÿçš„Objectå°†è·å¾—å”¯ä¸€çš„oid,å³Object ID,å…¶äº§ç”Ÿæ–¹å¼ä¹Ÿæ˜¯çº¿æ€§æ˜ å°„,æå…¶ç®€å•ã€‚
**Object â†’PGæ˜ å°„**
åœ¨Fileè¢«æ˜ å°„ä¸º1ä¸ªæˆ–å¤šä¸ªObjectä¹‹å,å°±éœ€è¦å°†æ¯ä¸ªObjectç‹¬ç«‹åœ°æ˜ å°„åˆ°1ä¸ªPGä¸­å»ã€‚è¿™ä¸ªæ˜ å°„è¿‡ç¨‹ä¹Ÿå¾ˆç®€å•,å¦‚å›¾æ‰€ç¤º,å…¶è®¡ç®—å…¬å¼å¦‚ä¸‹:
Hash(oid) & mask -> pgid
ç”±æ­¤å¯è§,å…¶è®¡ç®—ç”±ä¸¤æ­¥ç»„æˆã€‚é¦–å…ˆ,ä½¿ç”¨Cephç³»ç»ŸæŒ‡å®šçš„ä¸€ä¸ªé™æ€å“ˆå¸Œç®—æ³•è®¡ç®—oidçš„å“ˆå¸Œå€¼,å°†oidæ˜ å°„ä¸ºä¸€ä¸ªè¿‘ä¼¼å‡åŒ€åˆ†å¸ƒçš„ä¼ªéšæœºå€¼ã€‚ç„¶å,å°†è¿™ä¸ªä¼ªéšæœºå€¼å’ŒmaskæŒ‰ä½ç›¸ä¸,å¾—åˆ°æœ€ç»ˆçš„PGåºå·(pgid) ã€‚æ ¹æ®RADOSçš„è®¾è®¡,ç»™å®šPGçš„æ€»æ•°ä¸ºm(måº”è¯¥ä¸º2çš„æ•´æ•°å¹‚),åˆ™maskçš„å€¼ä¸ºm-1ã€‚å› æ­¤,å“ˆå¸Œå€¼è®¡ç®—å’ŒæŒ‰ä½ä¸æ“ä½œçš„æ•´ä½“ç»“æœäº‹å®ä¸Šæ˜¯ä»æ‰€æœ‰mä¸ªPGä¸­è¿‘ä¼¼å‡åŒ€åœ°éšæœºé€‰æ‹©1ä¸ªã€‚åŸºäºè¿™ä¸€æœºåˆ¶,å½“æœ‰å¤§é‡Objectå’Œå¤§é‡PGæ—¶, RADOSèƒ½å¤Ÿä¿è¯Objectå’ŒPGä¹‹é—´çš„è¿‘ä¼¼å‡åŒ€æ˜ å°„ã€‚åˆå› ä¸ºObjectæ˜¯ç”±Fileåˆ‡åˆ†è€Œæ¥çš„,å¤§éƒ¨åˆ†Objectçš„å°ºå¯¸ç›¸åŒ,å› æ­¤,è¿™ä¸€æ˜ å°„æœ€ç»ˆä¿è¯äº†å„ä¸ªPGä¸­å­˜å‚¨çš„Objectçš„æ€»æ•°æ®é‡è¿‘ä¼¼å‡åŒ€ã€‚
è¿™é‡Œåå¤å¼ºè°ƒäº†â€œå¤§é‡â€ ,æ„æ€æ˜¯åªæœ‰å½“Objectå’ŒPGçš„æ•°é‡è¾ƒå¤šæ—¶,è¿™ç§ä¼ªéšæœºå…³ç³»çš„è¿‘ä¼¼å‡åŒ€æ€§æ‰èƒ½æˆç«‹, Cephçš„æ•°æ®å­˜å‚¨å‡åŒ€æ€§æ‰æœ‰ä¿è¯ã€‚ä¸ºä¿è¯â€œå¤§é‡â€çš„æˆç«‹,ä¸€æ–¹é¢, Objectçš„æœ€å¤§å°ºå¯¸åº”è¯¥è¢«åˆç†é…ç½®,ä»¥ä½¿å¾—åŒæ ·æ•°é‡çš„Fileèƒ½å¤Ÿè¢«åˆ‡åˆ†æˆæ›´å¤šçš„Object;å¦ä¸€æ–¹é¢, Cephä¹Ÿæ¨èPGæ€»æ•°åº”è¯¥ä¸ºOSDæ€»æ•°çš„æ•°ç™¾å€,ä»¥ä¿è¯æœ‰è¶³å¤Ÿæ•°é‡çš„PGå¯ä¾›æ˜ å°„ã€‚
**PGâ†’ OSDæ˜ å°„**
ç¬¬3æ¬¡æ˜ å°„å°±æ˜¯å°†ä½œä¸ºObjectçš„é€»è¾‘ç»„ç»‡å•å…ƒçš„PGæ˜ å°„åˆ°æ•°æ®çš„å®é™…å­˜å‚¨å•å…ƒOSDä¸Šã€‚RADOSé‡‡ç”¨ä¸€ä¸ªåä¸ºCRUSHçš„ç®—æ³•,å°†pgidä»£å…¥å…¶ä¸­,ç„¶åå¾—åˆ°ä¸€ç»„å…±nä¸ªOSDã€‚è¿™nä¸ªOSDå…±åŒè´Ÿè´£å­˜å‚¨å’Œç»´æŠ¤ä¸€ä¸ªPGä¸­çš„æ‰€æœ‰Objectoå‰é¢æåˆ°è¿‡, nçš„æ•°å€¼å¯ä»¥æ ¹æ®å®é™…åº”ç”¨ä¸­å¯¹äºå¯é æ€§çš„éœ€æ±‚è€Œé…ç½®,åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹é€šå¸¸ä¸º3ã€‚å…·ä½“åˆ°æ¯ä¸ªOSD,åˆ™ç”±å…¶ä¸Šè¿è¡Œçš„OSD Daemonè´Ÿè´£æ‰§è¡Œæ˜ å°„åˆ°æœ¬åœ°çš„Objectåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„å­˜å‚¨ã€è®¿é—®ã€å…ƒæ•°æ®ç»´æŠ¤ç­‰æ“ä½œã€‚
å’Œâ€œObject â†’PG"æ˜ å°„ä¸­é‡‡ç”¨çš„å“ˆå¸Œç®—æ³•ä¸åŒ, CRUSHç®—æ³•çš„ç»“æœä¸æ˜¯ç»å¯¹ä¸å˜çš„,è€Œä¼šå—åˆ°å…¶ä»–å› ç´ çš„å½±å“ã€‚å…¶å½±å“å› ç´ ä¸»è¦æœ‰ä¸¤ä¸ªã€‚
ä¸€æ˜¯å½“å‰ç³»ç»ŸçŠ¶æ€,ä¹Ÿå°±æ˜¯åœ¨å‰é¢æœ‰æ‰€æåŠçš„é›†ç¾¤è¿è¡Œå›¾ã€‚å½“ç³»ç»Ÿä¸­çš„OSDçŠ¶æ€ã€æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶,é›†ç¾¤è¿è¡Œå›¾ä¹Ÿå¯èƒ½å‘ç”Ÿå˜åŒ–,è€Œè¿™ç§å˜åŒ–å°†ä¼šå½±å“åˆ°PGä¸OSDä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚
äºŒæ˜¯å­˜å‚¨ç­–ç•¥é…ç½®ã€‚è¿™é‡Œçš„ç­–ç•¥ä¸»è¦ä¸å®‰å…¨ç›¸å…³ã€‚åˆ©ç”¨ç­–ç•¥é…ç½®,ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æŒ‡å®šæ‰¿è½½åŒä¸€ä¸ªPGçš„3ä¸ªOSDåˆ†åˆ«ä½äºæ•°æ®ä¸­å¿ƒçš„ä¸åŒæœåŠ¡å™¨æˆ–æœºæ¶ä¸Š,ä»è€Œè¿›ä¸€æ­¥æ”¹å–„å­˜å‚¨çš„å¯é æ€§ã€‚
å› æ­¤,åªæœ‰åœ¨ç³»ç»ŸçŠ¶æ€å’Œå­˜å‚¨ç­–ç•¥éƒ½ä¸å‘ç”Ÿå˜åŒ–çš„æ—¶å€™, PGå’ŒOSDä¹‹é—´çš„æ˜ å°„å…³ç³»æ‰æ˜¯å›ºå®šä¸å˜çš„ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­,ç­–ç•¥ä¸€ç»é…ç½®é€šå¸¸ä¸ä¼šæ”¹å˜ã€‚è€Œç³»ç»ŸçŠ¶æ€çš„æ”¹å˜æˆ–æ˜¯å› ä¸ºè®¾å¤‡æŸå,æˆ–æ˜¯å› ä¸ºå­˜å‚¨é›†ç¾¤è§„æ¨¡æ‰©å¤§ã€‚å¥½åœ¨Cephæœ¬èº«æä¾›äº†å¯¹è¿™ç§å˜åŒ–çš„è‡ªåŠ¨åŒ–æ”¯æŒ,å› è€Œ,å³ä¾¿PGä¸OSDä¹‹é—´çš„æ˜ å°„å…³ç³»å‘ç”Ÿäº†å˜åŒ–,ä¹Ÿå¹¶ä¸ä¼šå¯¹åº”ç”¨äº§ç”Ÿå½±å“ã€‚äº‹å®ä¸Š, Cephæ­£æ˜¯åˆ©ç”¨äº†CRUSHç®—æ³•çš„åŠ¨æ€ç‰¹æ€§,å¯ä»¥å°†ä¸€ä¸ªPGæ ¹æ®éœ€è¦åŠ¨æ€è¿ç§»åˆ°ä¸åŒçš„OSDç»„åˆä¸Š,ä»è€Œè‡ªåŠ¨åŒ–åœ°å®ç°é«˜å¯é æ€§ã€æ•°æ®åˆ†å¸ƒå†å¹³è¡¡ç­‰ç‰¹æ€§ã€‚
ä¹‹æ‰€ä»¥åœ¨æ­¤æ¬¡æ˜ å°„ä¸­ä½¿ç”¨CRUSHç®—æ³•,è€Œä¸ä½¿ç”¨å…¶ä»–å“ˆå¸Œç®—æ³•,ä¸€æ–¹é¢åŸå› æ˜¯CRUSHç®—æ³•å…·æœ‰ä¸Šè¿°å¯é…ç½®ç‰¹æ€§,å¯ä»¥æ ¹æ®ç®¡ç†å‘˜çš„é…ç½®å‚æ•°å†³å®šOSDçš„ç‰©ç†ä½ç½®æ˜ å°„ç­–ç•¥;å¦ä¸€æ–¹é¢åŸå› æ˜¯CRUSHç®—æ³•å…·æœ‰ç‰¹æ®Šçš„â€œç¨³å®šæ€§" ,ä¹Ÿå³,å½“ç³»ç»Ÿä¸­åŠ å…¥æ–°çš„OSD,å¯¼è‡´ç³»ç»Ÿè§„æ¨¡å¢å¤§æ—¶,å¤§éƒ¨åˆ†PGä¸OSDä¹‹é—´çš„æ˜ å°„å…³ç³»ä¸ä¼šå‘ç”Ÿæ”¹å˜,åªæœ‰å°‘éƒ¨åˆ†PGçš„æ˜ å°„å…³ç³»ä¼šå‘ç”Ÿå˜åŒ–å¹¶å¼•å‘æ•°æ®è¿ç§»ã€‚è¿™ç§å¯é…ç½®æ€§å’Œç¨³å®šæ€§éƒ½ä¸æ˜¯æ™®é€šå“ˆå¸Œç®—æ³•æ‰€èƒ½æä¾›çš„ã€‚å› æ­¤, CRUSHç®—æ³•çš„è®¾è®¡ä¹Ÿæ˜¯Cephçš„æ ¸å¿ƒå†…å®¹ä¹‹ä¸€ã€‚
**è‡³æ­¤ä¸ºæ­¢, Cephé€šè¿‡3æ¬¡æ˜ å°„,å®Œæˆäº†ä»Fileåˆ°Object. Objectåˆ°PG,PGå†åˆ°OSDçš„æ•´ä¸ªæ˜ å°„è¿‡ç¨‹ã€‚ä»æ•´ä¸ªè¿‡ç¨‹å¯ä»¥çœ‹åˆ°,è¿™é‡Œæ²¡æœ‰ä»»ä½•çš„å…¨å±€æ€§æŸ¥è¡¨æ“ä½œéœ€æ±‚ã€‚è‡³äºå”¯ä¸€çš„å…¨å±€æ€§æ•°æ®ç»“æ„:é›†ç¾¤è¿è¡Œå›¾ã€‚å®ƒçš„ç»´æŠ¤å’Œæ“ä½œéƒ½æ˜¯è½»é‡çº§çš„,ä¸ä¼šå¯¹ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€æ€§èƒ½ç­‰å› ç´ é€ æˆå½±å“**ã€‚

### å­˜å‚¨è¿‡ç¨‹æ€»ç»“ï¼š

1.è®¡ç®—æ–‡ä»¶åˆ°å¯¹è±¡çš„æ˜ å°„

2.é€šè¿‡å“ˆå¸Œç®—æ³•è®¡ç®—è®¡ç®—å‡ºæ–‡ä»¶å¯¹åº”çš„poolçš„PG

3.é€šè¿‡CRUSHæŠŠå¯¹è±¡æ˜ å°„åˆ°PGä¸­çš„OSD

4.PGç§çš„OSDå°†å¯¹è±¡å†™å…¥åˆ°ç£ç›˜

5.ä¸»OSDå°†æ•°æ®åŒæ­¥åˆ°å¤‡ä»½OSDï¼Œå¾…å¤‡ä»½OSDè¿”å›ç¡®è®¤

6.ä¸»OSDçš„åˆ°å¤‡ä»½OSDå†™å®Œæ“ä½œä»¥åç»™å®¢æˆ·çš„è¿”å›å†™å…¥æˆåŠŸ

## 2. cephçš„è¯»å†™æµç¨‹

å½“æŸä¸ªå®¢æˆ·ç«¯éœ€è¦å‘Cephé›†ç¾¤å†™å…¥ä¸€ä¸ªFileæ—¶ï¼Œé¦–å…ˆéœ€è¦åœ¨æœ¬åœ°å®Œæˆå¯»å€æµç¨‹ï¼Œå°†Fileå˜ä¸ºä¸€ä¸ªObjectï¼Œç„¶åæ‰¾å‡ºå­˜å‚¨è¯¥Objectçš„ä¸€ç»„å…±3ä¸ªOSDï¼Œè¿™3ä¸ªOSDå…·æœ‰å„è‡ªä¸åŒçš„åºå·ï¼Œåºå·æœ€é å‰çš„é‚£ä¸ªOSDå°±æ˜¯è¿™ä¸€ç»„ä¸­çš„Primary OSDï¼Œè€Œåä¸¤ä¸ªåˆ™ä¾æ¬¡Secondary OSDå’ŒTertiary OSDã€‚
æ‰¾å‡º3ä¸ªOSDåï¼Œå®¢æˆ·ç«¯å°†ç›´æ¥å’ŒPrimary OSDè¿›è¡Œé€šä¿¡ï¼Œå‘èµ·å†™å…¥æ“ä½œ(æ­¥éª¤1)ã€‚ Primary OSDæ”¶åˆ°è¯·æ±‚åï¼Œåˆ†åˆ«å‘Secondary OSDå’ŒTertiary OSDå‘èµ·å†™äººæ“ä½œ(æ­¥éª¤2å’Œæ­¥éª¤3)ã€‚å½“Secondary OSDå’ŒTertiary OSDå„è‡ªå®Œæˆå†™å…¥æ“ä½œåï¼Œå°†åˆ†åˆ«å‘Primary OSDå‘é€ç¡®è®¤ä¿¡æ¯(æ­¥éª¤4å’Œæ­¥éª¤5)ã€‚å½“Primary OSDç¡®è®¤å…¶ä»–ä¸¤ä¸ªOSDçš„å†™å…¥å®Œæˆåï¼Œåˆ™è‡ªå·±ä¹Ÿå®Œæˆæ•°æ®å†™å…¥ï¼Œå¹¶å‘å®¢æˆ·ç«¯ç¡®è®¤Objectå†™å…¥æ“ä½œå®Œæˆ(æ­¥éª¤6)ã€‚
ä¹‹æ‰€ä»¥é‡‡ç”¨è¿™æ ·çš„å†™å…¥æµç¨‹ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸ºäº†ä¿è¯å†™å…¥è¿‡ç¨‹ä¸­çš„å¯é æ€§ï¼Œå°½å¯èƒ½é¿å…å‡ºç°æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚åŒæ—¶ï¼Œç”±äºå®¢æˆ·ç«¯åªéœ€è¦å‘Primary OSDå‘é€æ•°æ®ï¼Œå› æ­¤åœ¨äº’è”ç½‘ä½¿ç”¨åœºæ™¯ä¸‹çš„å¤–ç½‘å¸¦å®½å’Œæ•´ä½“è®¿é—®å»¶è¿Ÿåˆå¾—åˆ°äº†ä¸€å®šç¨‹åº¦çš„ä¼˜åŒ–ã€‚
å½“ç„¶ï¼Œè¿™ç§å¯é æ€§æœºåˆ¶å¿…ç„¶å¯¼è‡´è¾ƒé•¿çš„å»¶è¿Ÿï¼Œç‰¹åˆ«æ˜¯ï¼Œå¦‚æœç­‰åˆ°æ‰€æœ‰çš„OSDéƒ½å°†æ•°æ®å†™å…¥ç£ç›˜åå†å‘å®¢æˆ·ç«¯å‘é€ç¡®è®¤ä¿¡å·ï¼Œåˆ™æ•´ä½“å»¶è¿Ÿå¯èƒ½éš¾ä»¥å¿å—ã€‚å› æ­¤ï¼Œ Cephå¯ä»¥åˆ†ä¸¤æ¬¡å‘å®¢æˆ·ç«¯è¿›è¡Œç¡®è®¤ã€‚å½“å„ä¸ªOSDéƒ½å°†æ•°æ®å†™å…¥å†…å­˜ç¼“å†²åŒºåï¼Œå°±å…ˆå‘å®¢æˆ·ç«¯å‘é€ä¸€æ¬¡ç¡®è®¤ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å³å¯ä»¥å‘ä¸‹æ‰§è¡Œã€‚å¾…å„ä¸ªOSDéƒ½å°†æ•°æ®å†™å…¥ç£ç›˜åï¼Œä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæœ€ç»ˆç¡®è®¤ä¿¡å·ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®éœ€è¦åˆ é™¤æœ¬åœ°æ•°æ®ã€‚
åˆ†æä¸Šè¿°æµç¨‹å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç‹¬ç«‹å®ŒæˆOSDå¯»å€æ“ä½œï¼Œè€Œä¸å¿…ä¾èµ–äºå…¶ä»–ç³»ç»Ÿæ¨¡å—ã€‚å› æ­¤ï¼Œå¤§é‡çš„å®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å’Œå¤§é‡çš„OSDè¿›è¡Œå¹¶è¡Œæ“ä½œã€‚åŒæ—¶ï¼Œå¦‚æœä¸€ä¸ªFileè¢«åˆ‡åˆ†æˆå¤šä¸ªObjectï¼Œè¿™å¤šä¸ªObjectä¹Ÿå¯è¢«å¹¶è¡Œå‘é€è‡³å¤šä¸ªOSDä¸Šã€‚
ä»OSDçš„è§’åº¦æ¥çœ‹ï¼Œç”±äºåŒä¸€ä¸ªOSDåœ¨ä¸åŒçš„PGä¸­çš„è§’è‰²ä¸åŒï¼Œå› æ­¤ï¼Œå…¶å·¥ä½œå‹åŠ›ä¹Ÿå¯ä»¥è¢«å°½å¯èƒ½å‡åŒ€åœ°åˆ†æ‹…ï¼Œä»è€Œé¿å…å•ä¸ªOSDå˜æˆæ€§èƒ½ç“¶é¢ˆã€‚

**é—®ï¼šä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸‰å±‚æ˜ å°„è€Œä¸æ˜¯ä¸€å±‚ï¼Ÿ**

ç­”ï¼šå¦‚æœå°†objectç›´æ¥æ˜ å°„åˆ°ä¸€ç»„OSDä¸Šï¼Œå¦‚æœè¿™ç§ç®—æ³•æ˜¯å›ºå®šçš„å“ˆå¸Œç®—æ³•ï¼Œåˆ™æ„å‘³ç€ä¸€ä¸ªobjectè¢«å›ºå®šæ˜ å°„åœ¨ä¸€ç»„OSDä¸Šï¼Œå½“å…¶ä¸­ä¸€ä¸ªOSDæŸåæ—¶ï¼Œobjectä¹Ÿæ— æ³•éƒ¨ç½²åˆ°æ–°çš„OSDä¸Š(å› ä¸ºæ˜ å°„å‡½æ•°ä¸å…è®¸)ã€‚

å¦‚æœè®¾è®¡ä¸€ä¸ªåŠ¨æ€ç®—æ³•(ä¾‹å¦‚CRUSHç®—æ³•)æ¥å®Œæˆè¿™ä¸€æ˜ å°„ï¼Œç»“æœå°†æ˜¯å„ä¸ªOSDæ‰€å¤„ç†çš„æœ¬åœ°å…ƒæ•°æ®æš´å¢ï¼Œç”±æ­¤å¸¦æ¥çš„è®¡ç®—å¤æ‚åº¦å’Œç»´æŠ¤å·¥ä½œé‡ä¹Ÿæ˜¯éš¾ä»¥æ‰¿å—çš„ã€‚

ç»¼ä¸Šæ‰€è¯‰ï¼Œå¼•å…¥PGçš„å¥½å¤„è‡³å°‘æœ‰äºŒï¼šä¸€æ–¹é¢è¯•ä¸‹å‘¢objectå’ŒOSDä¹‹é—´çš„åŠ¨æ€æ˜ å°„ï¼Œä»è€Œä¸ºCephçš„å¯é æ€§ã€è‡ªåŠ¨åŒ–ç­‰ç‰¹æ€§çš„å®ç°ç•™ä¸‹äº†ç©ºé—´ï¼›å¦ä¸€æ–¹é¢ä¹Ÿæœ‰æ•ˆç®€åŒ–äº†æ•°æ®çš„å­˜å‚¨ç»„ç»‡ï¼Œå¤§å¤§é™ä½äº†ç³»ç»Ÿçš„ç»´æŠ¤ç®¡ç†å¼€é”€ã€‚

### 1.å‡†å¤‡å·¥ä½œ

1. æ—¶é—´åŒæ­¥`

   å®‰è£…ntpdateï¼ˆæ—¶é—´åŒæ­¥å·¥å…·ï¼‰

   ```shell
   # apt install ntpate
   ```

   ```shell
   0 * * * * ntpdate time1.aliyun.com
   ```

   ```shell
   echo  '0 * * * * ntpdate time1.aliyun.com' >> /var/spool/cron/crontabs/root
   ```

   æˆ–è€… å¯ä»¥é€šè¿‡

   ```shell
   ansible all -m shell -a "echo  '0 * * * * ntpdate time1.aliyun.com' >> /var/spool/cron/crontabs/root"
   ```

   

2. å…³é—­ selinux å’Œé˜²ç«å¢™

   ```shell
   root@node1:~# sudo ufw status  ##æŸ¥çœ‹çŠ¶æ€
   Status: inactive
   root@node1:~# sudo ufw disable
   Firewall stopped and disabled on system startup  ##ç¦ç”¨
   root@node1:~#
   ```

   

3. é…ç½®åŸŸåè§£ææˆ–é€šè¿‡ DNS è§£æ

   ```shell
   root@node1:~# cat /etc/hosts
   127.0.0.1	localhost
   root@node1:~# hostnamectl set-hostname å¯¹åº”çš„åç§°
   ## ä»¥ä¸‹æ˜¯æ–°å¢çš„ å¯ä»¥æŒ‰ç…§è‡ªå·±çš„ä¹ æƒ¯é…ç½®
   192.168.106.101  node1
   192.168.106.102  node2
   192.168.106.103  node3
   ```

   4. å®‰è£…python

      ```shell
      root@node1:~# apt install python  ##python2
      ```

   5. æºä¿®æ”¹æˆå›½å†…æº  -- å…·ä½“æ­¥éª¤è‡ªè¡Œç™¾åº¦

      ```yml
      https://mirrors.aliyun.com/ceph/ #é˜¿é‡Œäº‘é•œåƒä»“åº“
      http://mirrors.163.com/ceph/ #ç½‘æ˜“é•œåƒä»“åº“ 
      https://mirrors.tuna.tsinghua.edu.cn/ceph/ #æ¸…åå¤§å­¦é•œåƒæº
      ```

      cephç”¨åˆ°çš„ç«¯å£ (é˜²ç«å¢™å’Œå®‰å…¨ä¸­è®°å¾—æ”¾å¼€)

      ```yaml
      Ceph Monitorï¼šå¯ç”¨ Ceph MON æœåŠ¡æˆ–ç«¯å£ 6789 (TCP)ã€‚
      Ceph OSD æˆ–å…ƒæ•°æ®æœåŠ¡å™¨ï¼šå¯ç”¨ Ceph OSD/MDS æœåŠ¡æˆ–ç«¯å£ 6800-7300 (TCP)ã€‚
      iSCSI ç½‘å…³ï¼šæ‰“å¼€ç«¯å£ 3260 (TCP)ã€‚
      å¯¹è±¡ç½‘å…³ï¼šæ‰“å¼€å¯¹è±¡ç½‘å…³é€šè®¯æ‰€ç”¨çš„ç«¯å£ã€‚æ­¤ç«¯å£åœ¨ /etc/ceph.conf å†…ä»¥ rgw frontends = å¼€å¤´çš„è¡Œä¸­è®¾ç½®ã€‚HTTP çš„é»˜è®¤ç«¯å£ä¸º 80ï¼ŒHTTPS (TCP) çš„é»˜è®¤ç«¯å£ä¸º 443ã€‚
      NFS Ganeshaï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒNFS Ganesha ä½¿ç”¨ç«¯å£ 2049ï¼ˆNFS æœåŠ¡ã€TCPï¼‰å’Œ 875 ï¼ˆrquota æ”¯æŒã€TCPï¼‰ã€‚
      SSHï¼šæ‰“å¼€ç«¯å£ 22 (TCP)ã€‚
      NTPï¼šæ‰“å¼€ç«¯å£ 123 (UDP)ã€‚
      ```

      

   ### 2.æ­å»ºcephé›†ç¾¤

   #### å®‰è£…cephadm

   ```shell
   root@node1:~#  wget https://github.com/ceph/ceph/raw/pacific/src/cephadm/cephadm ## node1 ç®¡ç†èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
   root@node1:~#  chmod +x cephadm
   root@node1:~# ./cephadm add-repo --release pacific  ##è®¾ç½®è¦å®‰è£…çš„ç‰ˆæœ¬
   root@node1:~#  which cephadm   ##ç¡®è®¤æ˜¯å¦å®‰è£…æˆåŠŸ
   ```

   2. #### åˆå§‹åŒ–é›†ç¾¤

      ```shell
      root@node1:~# cephadm bootstrap --mon-ip 192.168.106.101   ##cephé›†ç¾¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ip
      ```

      åˆå§‹åŒ–å®Œäº†ä»¥åå°±å¯ä»¥è®¿é—®dashboardäº† åœ°å€ ï¼šhttps://node1:8443/#/dashboard è®¿é—®ç”¨æˆ·å¯†ç ä¸Šä¸€æ­¥ç”Ÿæˆ

   3. #### æ·»åŠ å…¶ä»–èŠ‚ç‚¹å’Œå…¶ä»–ç»„ä»¶

      ```shell
      root@node1:~# ssh-keygen
      ## é…ç½®å…å¯†é€šä¿¡
      root@node1:~#  ssh-copy-id -f -i /etc/ceph/ceph.pub root@node2
      root@node1:~#  ssh-copy-id -f -i /etc/ceph/ceph.pub root@node3
      ## æ·»åŠ node
      root@node1:~#  ceph orch host add node2 192.168.106.102
      root@node1:~#  ceph orch host add node3 192.168.106.103
      ## æ·»åŠ osd
      root@node1:~#  ceph orch daemon add osd node1:/dev/sdb
      root@node1:~#  ceph orch daemon add osd node1:/dev/sdb
      root@node1:~#  ceph orch daemon add osd node3:/dev/sdb
      ```

   4. #### æµ‹è¯•

      ```shell
      root@node1:~#  ceph fs volume create testfs  ##æ·»åŠ æµ‹è¯•fs
      root@node1:~#  ceph orch apply mds testfs --placement="3" ##è®¾ç½®å¤‡ä»½æ•°
      root@node1:~#   ceph orch daemon add mds testfs node1
      root@node1:~#   ceph mds stat
      
      ## åœ¨é›†ç¾¤ä¹‹å¤–çš„æˆ–è€…ä»»æ„æœºå™¨ä¸Šæ“ä½œ
      root@node4:~#  apt install ceph-common -y
      node1åˆå§‹åŒ–é›†ç¾¤çš„èŠ‚ç‚¹æ“ä½œ
      root@node1:~#  scp /etc/ceph/ceph.client.admin.keyring user@node4:/etc/ceph
      
      ##  é›†ç¾¤ä¹‹å¤–çš„clinetæˆ–è€…æµ‹è¯•èŠ‚ç‚¹æ‰§è¡Œ
      root@node4:~#  mount -t ceph node1:/ /mnt/testfs -o name=admin,secret=AQAoJjBh7OPVNhAAQZyzLhDfgSj+KPmeU5RVlA==,fs=testfs  
      root@node4:~#  mount -t ceph node2:/ /mnt/cephfs -o name=admin,secret=AQAoJjBh7OPVNhAAQZyzLhDfgSj+KPmeU5RVlA==,fs=testfs
      root@node4:~#  df -h
      Filesystem                  Size  Used Avail Use% Mounted on
      udev                        1.4G     0  1.4G   0% /dev
      tmpfs                       293M  1.2M  292M   1% /run
      ....
      192.168.106.101:/            18G 1000M   17G   6% /mnt/testfs  
      192.168.106.102:/            18G 1000M   17G   6% /mnt/cephfs
      
      root@node4:~#  cd /mnt/cephfs
      root@node4:/mnt/cephfs#  dd if=/dev/zero of=test bs=1M count=100 ##ç”Ÿæˆæ–‡ä»¶
      è¿™æ—¶å€™æ–‡ä»¶æ˜¯ç›´æ¥å†™åœ¨cephé›†ç¾¤ä¸Šçœ‹äº†ï¼Œ å¯ä»¥é€šè¿‡dashboardè§‚å¯ŸğŸ‘€ã€‚
      ```

      ![](https://github.com/EsqerYasen/ImgBox/blob/main/ceph-dashboard.png)

